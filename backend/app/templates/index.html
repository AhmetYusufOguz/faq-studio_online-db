<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"><title>FAQ Studio</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:800px;margin:24px auto;color:#eaeaea;background:#111}
    label{display:block;margin:10px 0 4px}
    textarea,input,select{width:100%;padding:8px;box-sizing:border-box;background:#2b2b2b;border:1px solid #3a3a3a;color:#eaeaea}
    button{margin-top:12px;padding:10px 14px;cursor:pointer;background:#2d5; border:0;color:#000}
    .warn{background:#3a2; border:1px solid #7c2; padding:10px; margin-top:10px}
    .ok{background:#163; border:1px solid #2a5; padding:10px; margin-top:10px}
    a{color:#7cc}
  </style>
</head>
<body>
  <h1>Soru Girişi</h1>

  <div style="margin:8px 0 18px;">
    <label>Eşik (benzerlik): <span id="thLabel">{{ '%.2f'|format(th_default) }}</span></label>
    <input id="th" type="range" min="0.50" max="0.90" step="0.01" value="{{ '%.2f'|format(th_default) }}" style="width:260px;">
    <a href="/questions-table" target="_blank" style="margin-left:12px;">Son kayıtlar</a>
  </div>

  <form id="qform" method="post" action="/add">
    <label>Soru</label><textarea name="question" rows="3" required></textarea>

    <button type="button" id="btnCheck">Benzer Soru Var mı?</button>
    <div id="dupBox"></div>

    <label>Cevap</label><textarea name="answer" rows="3" required></textarea>
    <label>Anahtar Kelimeler (virgüllerle)</label><input type="text" name="keywords" required />
    <label>Kategori</label>
    <select name="category" required>
      {% for c in categories %}<option value="{{ c }}">{{ c }}</option>{% endfor %}
    </select>
    <button type="submit">Kaydet</button>
    <div id="saveBox"></div>
  </form>

  <script>
    const form = document.getElementById('qform');
    const dupBox = document.getElementById('dupBox');
    const saveBox = document.getElementById('saveBox');
    const thInput = document.getElementById('th');
    const thLabel = document.getElementById('thLabel');
    thInput.oninput = () => { thLabel.textContent = Number(thInput.value).toFixed(2); };

    document.getElementById('btnCheck').onclick = async () => {
      dupBox.textContent = 'Kontrol ediliyor...';
      const onlyQ = new FormData();
      onlyQ.append('question', new FormData(form).get('question'));
      const resp = await fetch(`/check-duplicate?th=${encodeURIComponent(thInput.value)}&k=3`, { method:'POST', body: onlyQ });
      const d = await resp.json();
      if (d.results && d.results.length) {
        const items = d.results.map(x => `<li>${(x.sim||0).toFixed(2)} — ${x.question}</li>`).join('');
        if (d.duplicate) {
          dupBox.innerHTML = `<div class="warn"><b>Benzerler (eşik ${d.threshold.toFixed(2)}):</b><ul>${items}</ul></div>`;
        } else {
          dupBox.innerHTML = `<div class="ok">Benzer yok (eşik ${d.threshold.toFixed(2)}).<ul>${items}</ul></div>`;
        }
      } else {
        dupBox.innerHTML = `<div class="ok">Kayıt bulunamadı.</div>`;
      }
    };

    form.onsubmit = async (e) => {
      e.preventDefault();
      saveBox.textContent = 'Kaydediliyor...';
      const resp = await fetch('/add', { method:'POST', body: new FormData(form) });
      const d = await resp.json();
      if (d.ok) {
        saveBox.innerHTML = '<div class="ok">Kaydedildi (JSON + DB) ✅</div>';
        form.reset(); dupBox.innerHTML='';
      } else {
        saveBox.innerHTML = '<div class="warn">Kaydedilemedi.</div>';
      }
    };
  </script>
</body>
</html>
