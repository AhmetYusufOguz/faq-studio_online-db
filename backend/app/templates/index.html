<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"><title>FAQ Studio</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:800px;margin:24px auto;color:#eaeaea;background:#111}
    label{display:block;margin:10px 0 4px}
    textarea,input,select{width:100%;padding:8px;box-sizing:border-box;background:#3b3b3b;border:1px solid #3a3a3a;color:#eaeaea}
    button{margin-top:12px;padding:10px 14px;cursor:pointer;background:#2d5;border:0;color:#000}
    .warn{background:#3a2;border:1px solid #7c2;padding:10px;margin-top:10px}
    .ok{background:#163;border:1px solid #2a5;padding:10px;margin-top:10px}
    a{color:#7cc}
  </style>
</head>
<body>
  <h1>Soru Girişi</h1>

  <div style="margin:8px 0 18px;">
    <label>Eşik (benzerlik): <span id="thLabel">{{ th_default }}</span></label>
    <input id="th" type="range" min="0.50" max="0.90" step="0.01" value="{{ th_default }}" style="width:260px;">
    <button type="button" id="btnRecent" style="margin-left:12px;background:#09f;color:#000;border:0;padding:8px 12px;cursor:pointer;">Son kayıtlar</button>
    <button type="button" id="btnStats" style="margin-left:8px;background:#c07;color:#000;border:0;padding:8px 12px;cursor:pointer;">İstatistikler</button>
  </div>

  <form id="qform" method="post" action="/add">
    <label>Soru</label><textarea name="question" rows="3" required></textarea>

    <button type="button" id="btnCheck">Benzer Soru Var mı?</button>
    <div id="dupBox"></div>

    <label>Cevap</label><textarea name="answer" rows="3" required></textarea>
    <label>Anahtar Kelimeler (virgüllerle)</label><input type="text" name="keywords" required />
    
    <!-- created_by alanı eklendi -->
    <label>Ekleyen Kullanıcı</label>
    <input type="text" name="created_by" id="created_by" value="anonymous" 
           style="width: 200px;" placeholder="Kullanıcı adı">
    
    <label>Kategori</label>
    <select id="categorySel" name="category" required> 
      <option value="">Kategori seçin...</option>
      <option value="__new__">+ Yeni kategori ekle…</option> 
      {% for category in categories %}
      <option value="{{ category }}" {% if category == selected_category %}selected{% endif %}>
        {{ category }}
      </option>
      {% endfor %}
    </select>
    <button type="submit">Kaydet</button>
    <div id="saveBox"></div>
  </form>

  <!-- Recent Records Modal -->
  <div id="recentModal" aria-hidden="true" role="dialog" aria-labelledby="recentTitle"
       style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:9999;">
    <div style="background:#111; color:#eaeaea; width:min(950px, 96%); margin:60px auto; border:1px solid #333; border-radius:8px; overflow:hidden;">
      <div style="display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid #333;">
        <h3 id="recentTitle" style="margin:0;">Son 100 Kayıt <span id="recentCount">()</span></h3>
        <button id="closeRecent" aria-label="Kapat" title="Kapat"
                style="background:#222;color:#eee;border:1px solid #444;padding:6px 10px;cursor:pointer;">✕</button>
      </div>
      <div id="recentBody" style="max-height:65vh; overflow:auto;">
        <div style="display:flex; gap:8px; align-items:center; padding:10px 14px; border-bottom:1px solid #222;">
          <input id="recentSearch" type="text" placeholder="Ara (soru/cevap/keyword/kategori)..." 
                style="flex:1; padding:8px; background:#222; border:1px solid #444; color:#eee;">
          <button id="recentClear" style="background:#444;color:#eee;border:1px solid #555;padding:8px 12px;cursor:pointer;">Temizle</button>
        </div>
        <div id="recentLoading" style="padding:14px;">Yükleniyor…</div>
        <table id="recentTable" style="width:100%; border-collapse:collapse; display:none;">
          <thead>
            <tr>
              <th style="text-align:left;border-bottom:1px solid #333;padding:8px;">ID</th>
              <th style="text-align:left;border-bottom:1px solid #333;padding:8px;">Soru</th>
              <th style="text-align:left;border-bottom:1px solid #333;padding:8px;">Kategori</th>
              <th style="text-align:left;border-bottom:1px solid #333;padding:8px;">Tarih</th>
              <th style="text-align:left;border-bottom:1px solid #333;padding:8px;">Ekleyen</th>
              <th style="text-align:left;border-bottom:1px solid #333;padding:8px;">İşlem</th>
            </tr>
          </thead>
          <tbody id="recentTbody"></tbody>
        </table>
        <div id="recentError" style="display:none; padding:14px; background:#2b1d1d; border-top:1px solid #533;">Hata oluştu.</div>
      </div>
      <div style="padding:10px 14px; border-top:1px solid #333; display:flex; gap:8px; justify-content:flex-end;">
        <button id="refreshRecent" style="background:#2d5;color:#000;border:0;padding:8px 12px;cursor:pointer;">Yenile</button>
        <button id="closeRecent2" style="background:#222;color:#eee;border:1px solid #444;padding:8px 12px;cursor:pointer;">Kapat</button>
      </div>
    </div>
  </div>

  <!-- Stats Modal -->
  <div id="statsModal" aria-hidden="true" role="dialog"
      style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:9999;">
    <div style="background:#111;color:#eaeaea;width:min(950px,96%);margin:60px auto;border:1px solid #333;border-radius:8px;overflow:hidden;">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid #333;">
        <h3 style="margin:0;">Kategori Dağılımı</h3>
        <button id="closeStats" style="background:#222;color:#eee;border:1px solid #444;padding:6px 10px;cursor:pointer;">✕</button>
      </div>
      <div style="padding:12px 14px;">
        <canvas id="catChart" width="880" height="320"></canvas>
        <div id="statsLegend" style="margin-top:8px;font-size:14px;color:#aaa;"></div>
      </div>
      <div style="padding:10px 14px;border-top:1px solid #333;display:flex;gap:8px;justify-content:flex-end;">
        <button id="refreshStats" style="background:#2d5;color:#000;border:0;padding:8px 12px;cursor:pointer;">Yenile</button>
        <button id="closeStats2" style="background:#222;color:#eee;border:1px solid #444;padding:8px 12px;cursor:pointer;">Kapat</button>
      </div>
    </div>
  </div>

  <!-- Silme Modal'ı -->
  <div id="deleteModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:10000;">
    <div style="background:#111; padding:20px; margin:100px auto; width:300px; border:1px solid #333; border-radius:8px;">
      <h3 style="margin-top:0;">Soru Sil</h3>
      <p>ID: <span id="deleteId"></span> silinecek</p>
      <p><strong>Soru:</strong> <span id="deleteQuestion" style="color:#ff6b6b; word-break:break-word;"></span></p>
      
      <label>Silen Kullanıcı:</label>
      <input type="text" id="deleterName" value="" 
            placeholder="Kullanıcı adınız" style="width:100%; padding:8px; margin:5px 0;">
      
      <div style="display:flex; gap:10px; margin-top:15px;">
        <button onclick="confirmDelete()" 
                style="background:#933; color:white; border:0; padding:8px 15px; cursor:pointer;">Sil</button>
        <button onclick="closeDeleteModal()" 
                style="background:#444; color:white; border:0; padding:8px 15px; cursor:pointer;">İptal</button>
      </div>
    </div>
  </div>

  <script>
    // === GLOBAL VARIABLES ===
    const form = document.getElementById('qform');
    const dupBox = document.getElementById('dupBox');
    const saveBox = document.getElementById('saveBox');
    const thInput = document.getElementById('th');
    const thLabel = document.getElementById('thLabel');
    const catSel = document.getElementById('categorySel');
    const createdByInput = document.getElementById('created_by');
    
    // Recent modal elements
    const recentModal = document.getElementById('recentModal');
    const recentSearch = document.getElementById('recentSearch');
    const recentClear = document.getElementById('recentClear');
    
    // Stats modal elements
    const statsModal = document.getElementById('statsModal');
    
    // Search query state
    let recentQuery = "";

    // === UTILITY FUNCTIONS ===
    function debounce(fn, ms = 300) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), ms);
      };
    }

    function safeHtml(str) {
      return String(str ?? '').replace(/[<>]/g, ch => ({'<': '&lt;', '>': '&gt;'}[ch]));
    }

    // === THRESHOLD SLIDER ===
    thInput.oninput = () => {
      thLabel.textContent = Number(thInput.value).toFixed(2);
    };

    // === DUPLICATE CHECK ===
    document.getElementById('btnCheck').onclick = async () => {
      dupBox.textContent = 'Kontrol ediliyor...';
      const onlyQ = new FormData();
      onlyQ.append('question', new FormData(form).get('question'));
      const question = new FormData(form).get('question');
  
      // Basit validation
      if (!question || question.trim().length < 3) {
        dupBox.innerHTML = '<div class="warn">Lütfen en az 3 karakterlik bir soru yazın!</div>';
        return;
      }
      
      try {
        const resp = await fetch(`/check-duplicate?th=${encodeURIComponent(thInput.value)}&k=3`, { 
          method: 'POST', 
          body: onlyQ 
        });
        const d = await resp.json();
        
        if (d.results && d.results.length) {
          const items = d.results.map(x => 
            `<li>${(x.sim || 0).toFixed(2)} — ${safeHtml(x.question)}</li>`
          ).join('');
          
          if (d.duplicate) {
            dupBox.innerHTML = `<div class="warn"><b>Benzerler (eşik ${d.threshold.toFixed(2)}):</b><ul>${items}</ul></div>`;
          } else {
            dupBox.innerHTML = `<div class="ok">Benzer yok (eşik ${d.threshold.toFixed(2)}).<ul>${items}</ul></div>`;
          }
        } else {
          dupBox.innerHTML = `<div class="ok">Kayıt bulunamadı.</div>`;
        }
      } catch (error) {
        dupBox.innerHTML = `<div class="warn">Kontrol hatası: ${error.message}</div>`;
      }
    };

    // === FORM SUBMISSION ===
    form.onsubmit = async (e) => {
      e.preventDefault();
      saveBox.textContent = 'Kaydediliyor...';
      
      try {
        const resp = await fetch('/add', { method: 'POST', body: new FormData(form) });
        const d = await resp.json();
        
        if (d.ok) {
          saveBox.innerHTML = '<div class="ok">Kaydedildi (JSON + DB) ✅</div>';
          form.reset();
          // created_by alanını sıfırlama (default değerini koru)
          createdByInput.value = 'anonymous';
          dupBox.innerHTML = '';
          // Kategorileri yenile (yeni kategori eklenmiş olabilir)
          await refreshCategories();
        } else {
          saveBox.innerHTML = '<div class="warn">Kaydedilemedi.</div>';
        }
      } catch (error) {
        saveBox.innerHTML = `<div class="warn">Kaydetme hatası: ${error.message}</div>`;
      }
    };

    // === CATEGORY SELECTION ===
    catSel.addEventListener('change', () => {
      if (catSel.value === '__new__') {
        const yeni = prompt('Yeni kategori adı:');
        if (yeni && yeni.trim()) {
          const opt = document.createElement('option');
          opt.value = yeni.trim();
          opt.textContent = yeni.trim();
          catSel.insertBefore(opt, catSel.lastElementChild);
          catSel.value = yeni.trim();
        } else {
          catSel.value = '';
        }
      }
    });

    // === CATEGORY MANAGEMENT ===
    async function refreshCategories() {
      try {
        const response = await fetch('/categories.json');
        if (!response.ok) throw new Error('Kategoriler yüklenemedi');
        
        const categories = await response.json();
        updateCategorySelect(categories);
        
      } catch (error) {
        console.error('Kategori yenileme hatası:', error);
      }
    }

    function updateCategorySelect(categories) {
      const currentValue = catSel.value;
      
      // Clear existing options except the first two (default and "new category")
      while (catSel.children.length > 2) {
        catSel.removeChild(catSel.lastElementChild);
      }
      
      // Add categories
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        catSel.insertBefore(option, catSel.lastElementChild); // Insert before "Yeni kategori ekle"
      });
      
      // Restore previous selection if it still exists
      if (currentValue && categories.includes(currentValue)) {
        catSel.value = currentValue;
      }
    }

    // === RECENT MODAL FUNCTIONS ===
    function openRecentModal() {
      recentModal.style.display = 'block';
      recentModal.setAttribute('aria-hidden', 'false');
    }

    function closeRecentModal() {
      recentModal.style.display = 'none';
      recentModal.setAttribute('aria-hidden', 'true');
    }

    async function loadRecentRecords() {
      const countSpan = document.getElementById('recentCount');
      const loading = document.getElementById('recentLoading');
      const table = document.getElementById('recentTable');
      const tbody = document.getElementById('recentTbody');
      const errorDiv = document.getElementById('recentError');

      // Reset UI state
      loading.style.display = 'block';
      table.style.display = 'none';
      errorDiv.style.display = 'none';
      tbody.innerHTML = '';

      try {
        // Determine URL based on search query
        const url = recentQuery
          ? `/questions/search?query=${encodeURIComponent(recentQuery)}&limit=100`
          : `/questions?limit=100&offset=0`;

        // Fetch data and total count
        const [dataResponse, totalResponse] = await Promise.all([
          fetch(url),
          fetch('/stats/total')
        ]);

        if (!dataResponse.ok) throw new Error('HTTP ' + dataResponse.status);

        const rows = await dataResponse.json();
        const total = totalResponse.ok ? (await totalResponse.json()).total : null;

        // Update count display
        if (countSpan) {
          countSpan.textContent = total !== null ? `(${total})` : '';
        }

        // Populate table
        if (!Array.isArray(rows) || rows.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="padding:8px;color:#aaa;">Kayıt bulunamadı.</td></tr>';
        } else {
          for (const record of rows) {
            tbody.insertAdjacentHTML('beforeend',
              `<tr data-row-id="${record.id ?? ''}">
                 <td style="border-bottom:1px solid #222;padding:8px;">${record.id ?? ''}</td>
                 <td style="border-bottom:1px solid #222;padding:8px;">${safeHtml(record.question)}</td>
                 <td style="border-bottom:1px solid #222;padding:8px;">${safeHtml(record.category)}</td>
                 <td style="border-bottom:1px solid #222;padding:8px;">${safeHtml(record.created_at)}</td>
                 <td style="border-bottom:1px solid #222;padding:8px;">${safeHtml(record.created_by || 'anonymous')}</td>
                 <td style="border-bottom:1px solid #222;padding:8px;">
                    <button class="btn-del" data-id="${record.id ?? ''}" style="background:#933;color:#fff;border:0;padding:6px 10px;cursor:pointer;">Sil</button>
                  </td>
               </tr>`);
          }
        }

        table.style.display = 'table';
      } catch (error) {
        errorDiv.textContent = 'Hata: ' + error.message;
        errorDiv.style.display = 'block';
      } finally {
        loading.style.display = 'none';
      }
    }

    // === STATS MODAL FUNCTIONS ===
    function openStatsModal() {
      statsModal.style.display = 'block';
      statsModal.setAttribute('aria-hidden', 'false');
    }

    function closeStatsModal() {
      statsModal.style.display = 'none';
      statsModal.setAttribute('aria-hidden', 'true');
    }

    async function loadStatsData() {
      try {
        const response = await fetch('/stats/categories');
        if (!response.ok) throw new Error('HTTP ' + response.status);
        
        const rows = await response.json();
        
        // Normalize data structure
        const data = rows.map(x => ({
          category: x.category ?? x['category'],
          cnt: Number(x.cnt ?? x['cnt'] ?? 0)
        }));

        // Draw chart
        drawCategoryChart(data);
        
        // Update legend
        const legend = document.getElementById('statsLegend');
        legend.textContent = data.length 
          ? data.map(d => `${d.category}: ${d.cnt}`).join(' • ') 
          : 'Kayıt yok';
          
      } catch (error) {
        alert('İstatistik hatası: ' + error.message);
      }
    }

    function drawCategoryChart(data) {
      const canvas = document.getElementById('catChart');
      const ctx = canvas.getContext('2d');
      const W = canvas.width;
      const H = canvas.height;
      
      // Clear canvas
      ctx.clearRect(0, 0, W, H);
      ctx.fillStyle = '#111';
      ctx.fillRect(0, 0, W, H);

      if (!data.length) return;

      const padding = 40;
      const barGap = 14;
      const maxCnt = Math.max(1, ...data.map(d => d.cnt));
      const barW = Math.max(10, (W - padding * 2 - barGap * (data.length - 1)) / Math.max(1, data.length));

      // Draw axes
      ctx.strokeStyle = '#444';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padding, padding);
      ctx.lineTo(padding, H - padding);
      ctx.lineTo(W - padding, H - padding);
      ctx.stroke();

      // Draw bars
      ctx.fillStyle = '#4ea';
      data.forEach((d, i) => {
        const x = padding + i * (barW + barGap);
        const barHeight = Math.round((H - padding * 2) * (d.cnt / maxCnt));
        const y = (H - padding) - barHeight;
        ctx.fillRect(x, y, barW, barHeight);
      });

      // Draw count labels on bars
      ctx.fillStyle = '#aaa';
      ctx.font = '12px system-ui, Arial';
      ctx.textAlign = 'center';
      data.forEach((d, i) => {
        const x = padding + i * (barW + barGap);
        const barHeight = Math.round((H - padding * 2) * (d.cnt / maxCnt));
        const y = (H - padding) - barHeight;
        ctx.fillText(String(d.cnt), x + barW / 2, y - 6);
      });

      // Draw category labels
      data.forEach((d, i) => {
        const x = padding + i * (barW + barGap);
        ctx.fillText(String(d.category), x + barW / 2, H - padding + 16);
      });
    }

    // === EVENT LISTENERS ===

    // Recent modal events
    document.getElementById('btnRecent').onclick = async () => {
      openRecentModal();
      await loadRecentRecords();
    };

    document.getElementById('closeRecent').onclick = closeRecentModal;
    document.getElementById('closeRecent2').onclick = closeRecentModal;
    document.getElementById('refreshRecent').onclick = loadRecentRecords;

    // Recent modal backdrop click
    recentModal.addEventListener('click', (e) => {
      if (e.target === recentModal) closeRecentModal();
    });

    // Search functionality
    recentSearch.addEventListener('input', debounce(() => {
      recentQuery = recentSearch.value.trim();
      loadRecentRecords();
    }, 300));

    recentClear.onclick = () => {
      recentSearch.value = '';
      recentQuery = '';
      loadRecentRecords();
    };

    // Stats modal events
    document.getElementById('btnStats').onclick = async () => {
      openStatsModal();
      await loadStatsData();
    };

    document.getElementById('closeStats').onclick = closeStatsModal;
    document.getElementById('closeStats2').onclick = closeStatsModal;
    document.getElementById('refreshStats').onclick = loadStatsData;

    // Stats modal backdrop click
    statsModal.addEventListener('click', (e) => {
      if (e.target === statsModal) closeStatsModal();
    });

    // created_by alanı için localStorage desteği
    (function() {
      // Sayfa yüklendiğinde localStorage'dan kullanıcı adını yükle
      const savedUser = localStorage.getItem('faq_studio_user');
      if (savedUser) {
        createdByInput.value = savedUser;
      }

      // Kullanıcı adı değiştiğinde localStorage'a kaydet
      createdByInput.addEventListener('change', function() {
        if (this.value.trim()) {
          localStorage.setItem('faq_studio_user', this.value.trim());
        }
      });
    })();

    // Silme modalı için
    let currentDeleteId = null;
    let currentDeleteQuestion = null;

    function showDeleteModal(id, question) {
      currentDeleteId = id;
      currentDeleteQuestion = question;
      
      document.getElementById('deleteId').textContent = id;
      document.getElementById('deleteQuestion').textContent = question;
      
      // Kullanıcı adını doldur (localStorage'dan)
      const savedUser = localStorage.getItem('faq_studio_user');
      document.getElementById('deleterName').value = savedUser || 'anonymous';
      
      document.getElementById('deleteModal').style.display = 'block';
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').style.display = 'none';
      currentDeleteId = null;
      currentDeleteQuestion = null;
    }

    async function confirmDelete() {
      const deletedBy = document.getElementById('deleterName').value || 'anonymous';
      
      try {
        const formData = new FormData();
        formData.append('deleted_by', deletedBy);
        
        const response = await fetch(`/questions/${currentDeleteId}`, {
          method: 'DELETE',
          body: formData
        });
        
        if (response.ok) {
          // Listeyi yenile
          await loadRecentRecords();
          closeDeleteModal();
        }
      } catch (error) {
        alert('Silme hatası: ' + error.message);
      }
    }

    // Sil butonlarını modal'a bağla (soru bilgisini de al)
    document.getElementById('recentTbody').addEventListener('click', async (e) => {
      const btn = e.target.closest('.btn-del');
      if (!btn) return;
      
      const tr = btn.closest('tr');
      if (!tr) return;
      
      const id = btn.getAttribute('data-id');
      const question = tr.querySelector('td:nth-child(2)').textContent; // Soru sütunundan al
      
      if (id && question) {
        showDeleteModal(id, question);
      }
    });

    // Sayfa yüklendiğinde kategorileri yükle
    document.addEventListener('DOMContentLoaded', async () => {
      await refreshCategories();
    });
  </script>
</body>
</html>