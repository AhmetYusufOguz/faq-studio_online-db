<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>FAQ Studio</title>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:800px;margin:24px auto;color:#cccccc;background:#111}
    label{display:block;margin:10px 0 4px}
    textarea,input,select{width:100%;padding:8px;box-sizing:border-box;background:#3b3b3b;border:1px solid #3a3a3a;color:#cccccc}
    button{margin-top:12px;padding:10px 14px;cursor:pointer;background:#2d5;border:0;color:#000}
    .warn{background:#3a2;border:1px solid #7c2;padding:10px;margin-top:10px}
    .ok{background:#163;border:1px solid #2a5;padding:10px;margin-top:10px}
    a{color:#7cc}
  </style>
</head>
<body>
  <h1>Soru Girişi</h1>

  <div style="margin:8px 0 18px;">
    <label>Eşik (benzerlik): <span id="thLabel">{{ th_default }}</span></label>
    <input id="th" type="range" min="0.50" max="0.90" step="0.01" value="{{ th_default }}" style="width:260px;">
    <button type="button" id="btnRecent" style="margin-left:12px;background:#09f;color:#000;border:0;padding:8px 12px;cursor:pointer;">Son kayıtlar</button>
    <button type="button" id="btnStats" style="margin-left:8px;background:#c07;color:#000;border:0;padding:8px 12px;cursor:pointer;">İstatistikler</button>
  </div>

  <form id="qform" method="post" action="/add">
    <label>Soru</label><textarea name="question" rows="3" required></textarea>

    <button type="button" id="btnCheck">Benzer Soru Var mı?</button>
    <div id="dupBox"></div>

    <label>Cevap</label><textarea name="answer" rows="3" required></textarea>
    <label>Anahtar Kelimeler (virgüllerle)</label><input type="text" name="keywords" required />
    
    <!-- created_by alanı eklendi -->
    <label>Ekleyen Kullanıcı</label>
    <input type="text" name="created_by" id="created_by" value="anonymous" 
           style="width: 200px;" placeholder="Kullanıcı adı">
    
    <label>Kategori</label>
    <select id="categorySel" name="category" required> 
      <option value="">Kategori seçin...</option>
      <option value="__new__">+ Yeni kategori ekle…</option> 
      {% for category in categories %}
      <option value="{{ category }}" {% if category == selected_category %}selected{% endif %}>
        {{ category }}
      </option>
      {% endfor %}
    </select>
    <button type="submit">Kaydet</button>
    <div id="saveBox"></div>
  </form>

  <!-- Recent Records Modal -->
  <div id="recentModal" aria-hidden="true" role="dialog" aria-labelledby="recentTitle"
       style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:9999;">
    <div style="background:#111; color:#cccccc; width:min(950px, 96%); margin:60px auto; border:1px solid #333; border-radius:8px; overflow:hidden;">
      <div style="display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid #333;">
        <h3 id="recentTitle" style="margin:0;">Son 100 Kayıt <span id="recentCount">()</span></h3>
        <button id="closeRecent" aria-label="Kapat" title="Kapat"
                style="background:#222;color:#eee;border:1px solid #444;padding:6px 10px;cursor:pointer;">✕</button>
      </div>
      <div id="recentBody" style="max-height:65vh; overflow:auto;">
        <div style="display:flex; gap:8px; align-items:center; padding:10px 14px; border-bottom:1px solid #222;">
          <input id="recentSearch" type="text" placeholder="Ara (soru/cevap/keyword/kategori)..." 
                style="flex:1; padding:8px; background:#222; border:1px solid #444; color:#eee;">
          <button id="recentClear" style="background:#444;color:#eee;border:1px solid #555;padding:8px 12px;cursor:pointer;">Temizle</button>
        </div>
        <div id="recentLoading" style="padding:14px;">Yükleniyor…</div>
        <table id="recentTable" style="width:100%; border-collapse:collapse; display:none;">
          <thead>
            <tr>
              <th style="text-align:left;border-bottom:1px solid #333;padding:8px;">ID</th>
              <th style="text-align:left;border-bottom:1px solid #333;padding:8px;">Soru</th>
              <th style="text-align:left;border-bottom:1px solid #333;padding:8px;">Kategori</th>
              <th style="text-align:left;border-bottom:1px solid #333;padding:8px;">Tarih</th>
              <th style="text-align:left;border-bottom:1px solid #333;padding:8px;">Ekleyen</th>
              <th style="text-align:left;border-bottom:1px solid #333;padding:8px;">İşlem</th>
            </tr>
          </thead>
          <tbody id="recentTbody"></tbody>
        </table>
        <div id="recentError" style="display:none; padding:14px; background:#2b1d1d; border-top:1px solid #533;">Hata oluştu.</div>
      </div>
      <div style="padding:10px 14px; border-top:1px solid #333; display:flex; gap:8px; justify-content:flex-end;">
        <button id="refreshRecent" style="background:#2d5;color:#000;border:0;padding:8px 12px;cursor:pointer;">Yenile</button>
        <button id="closeRecent2" style="background:#222;color:#eee;border:1px solid #444;padding:8px 12px;cursor:pointer;">Kapat</button>
      </div>
    </div>
  </div>

  <!-- Stats Modal -->
  <div id="statsModal" aria-hidden="true" role="dialog"
      style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:9999;">
    <div style="background:#111;color:#cccccc;width:min(95%,1200px);margin:40px auto;border:1px solid #333;border-radius:8px;overflow:hidden;">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:15px 20px;border-bottom:1px solid #333;">
        <h3 style="margin:0;">Kategori İstatistikleri</h3>
        <button id="closeStats" style="background:#222;color:#eee;border:1px solid #444;padding:6px 12px;cursor:pointer;">✕</button>
      </div>
      
      <div style="padding:20px;">
        <!-- Grafik Container -->
        <div style="position:relative; height:400px; margin-bottom:20px;">
          <canvas id="catChart"></canvas>
        </div>
        
        <!-- Detaylı İstatistikler -->
        <div id="statsDetails" style="background:#1a1a1a;padding:15px;border-radius:6px;">
          <h4 style="margin-top:0;color:#4ea;">Özet İstatistikler</h4>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
            <div>
              <strong>Toplam Soru:</strong> <span id="totalQuestions">0</span>
            </div>
            <div>
              <strong>Kategori Sayısı:</strong> <span id="totalCategories">0</span>
            </div>
            <div>
              <strong>Ort. Soru/Kategori:</strong> <span id="avgPerCategory">0</span>
            </div>
          </div>
        </div>
      </div>
      
      <div style="padding:15px 20px;border-top:1px solid #333;display:flex;gap:10px;justify-content:flex-end;">
        <button id="exportStats" style="background:#09f;color:#000;border:0;padding:8px 15px;cursor:pointer;">Dışa Aktar</button>
        <button id="refreshStats" style="background:#2d5;color:#000;border:0;padding:8px 15px;cursor:pointer;">Yenile</button>
        <button id="closeStats2" style="background:#222;color:#eee;border:1px solid #444;padding:8px 15px;cursor:pointer;">Kapat</button>
      </div>
    </div>
  </div>

  <!-- Silme Modal'ı -->
  <div id="deleteModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:10000;">
    <div style="background:#111; padding:20px; margin:100px auto; width:300px; border:1px solid #333; border-radius:8px;">
      <h3 style="margin-top:0;">Soru Sil</h3>
      <p>ID: <span id="deleteId"></span> silinecek</p>
      <p><strong>Soru:</strong> <span id="deleteQuestion" style="color:#ff6b6b; word-break:break-word;"></span></p>
      
      <label>Silen Kullanıcı:</label>
      <input type="text" id="deleterName" value="" 
            placeholder="Kullanıcı adınız" style="width:100%; padding:8px; margin:5px 0;">
      
      <div style="display:flex; gap:10px; margin-top:15px;">
        <button onclick="confirmDelete()" 
                style="background:#933; color:white; border:0; padding:8px 15px; cursor:pointer;">Sil</button>
        <button onclick="closeDeleteModal()" 
                style="background:#444; color:white; border:0; padding:8px 15px; cursor:pointer;">İptal</button>
      </div>
    </div>
  </div>

  <script>
    // === GLOBAL VARIABLES ===
    const form = document.getElementById('qform');
    const dupBox = document.getElementById('dupBox');
    const saveBox = document.getElementById('saveBox');
    const thInput = document.getElementById('th');
    const thLabel = document.getElementById('thLabel');
    const catSel = document.getElementById('categorySel');
    const createdByInput = document.getElementById('created_by');
    
    // Recent modal elements
    const recentModal = document.getElementById('recentModal');
    const recentSearch = document.getElementById('recentSearch');
    const recentClear = document.getElementById('recentClear');
    
    // Stats modal elements
    const statsModal = document.getElementById('statsModal');
    
    // Search query state
    let recentQuery = "";

    // === UTILITY FUNCTIONS ===
    function debounce(fn, ms = 300) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), ms);
      };
    }

    function safeHtml(str) {
      return String(str ?? '').replace(/[<>]/g, ch => ({'<': '&lt;', '>': '&gt;'}[ch]));
    }

    // === THRESHOLD SLIDER ===
    thInput.oninput = () => {
      thLabel.textContent = Number(thInput.value).toFixed(2);
    };

    // === DUPLICATE CHECK ===
    document.getElementById('btnCheck').onclick = async () => {
      dupBox.textContent = 'Kontrol ediliyor...';
      const onlyQ = new FormData();
      onlyQ.append('question', new FormData(form).get('question'));
      const question = new FormData(form).get('question');
  
      // Basit validation
      if (!question || question.trim().length < 3) {
        dupBox.innerHTML = '<div class="warn">Lütfen en az 3 karakterlik bir soru yazın!</div>';
        return;
      }
      
      try {
        const resp = await fetch(`/check-duplicate?th=${encodeURIComponent(thInput.value)}&k=3`, { 
          method: 'POST', 
          body: onlyQ 
        });
        const d = await resp.json();
        
        if (d.results && d.results.length) {
          const items = d.results.map(x => 
            `<li>${(x.sim || 0).toFixed(2)} — ${safeHtml(x.question)}</li>`
          ).join('');
          
          if (d.duplicate) {
            dupBox.innerHTML = `<div class="warn"><b>Benzerler (eşik ${d.threshold.toFixed(2)}):</b><ul>${items}</ul></div>`;
          } else {
            dupBox.innerHTML = `<div class="ok">Benzer yok (eşik ${d.threshold.toFixed(2)}).<ul>${items}</ul></div>`;
          }
        } else {
          dupBox.innerHTML = `<div class="ok">Kayıt bulunamadı.</div>`;
        }
      } catch (error) {
        dupBox.innerHTML = `<div class="warn">Kontrol hatası: ${error.message}</div>`;
      }
    };

    // === FORM SUBMISSION ===
    form.onsubmit = async (e) => {
        e.preventDefault();
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Kaydediliyor...';
        submitBtn.disabled = true;
        
        try {
            const resp = await fetch('/add', { method: 'POST', body: new FormData(form) });
            const d = await resp.json();
            
            if (d.ok) {
                saveBox.innerHTML = '<div class="ok">Kaydedildi (JSON + DB) ✅</div>';
                
                // FORM'U TAMAMEN RESETLE ve SAYFAYI YENİLE
                form.reset();
                
                // Kullanıcı adını localStorage'dan geri yükle
                const savedUser = localStorage.getItem('faq_studio_user');
                createdByInput.value = savedUser || 'anonymous';
                
                // Kategorileri yeniden yükle
                await refreshCategories();
                
                // Benzer soru kutusunu temizle
                dupBox.innerHTML = '';
                
                // 2 saniye sonra sayfayı tamamen yenile (isteğe bağlı)
                setTimeout(() => {
                    location.reload();
                }, 2000);
                
            } else {
                saveBox.innerHTML = '<div class="warn">Kaydedilemedi.</div>';
            }
        } catch (error) {
            saveBox.innerHTML = `<div class="warn">Kaydetme hatası: ${error.message}</div>`;
        } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    };

    // === CATEGORY SELECTION ===
    catSel.addEventListener('change', () => {
      if (catSel.value === '__new__') {
        const yeni = prompt('Yeni kategori adı:');
        if (yeni && yeni.trim()) {
          const opt = document.createElement('option');
          opt.value = yeni.trim();
          opt.textContent = yeni.trim();
          catSel.insertBefore(opt, catSel.lastElementChild);
          catSel.value = yeni.trim();
        } else {
          catSel.value = '';
        }
      }
    });

    // === CATEGORY MANAGEMENT ===
    // categories.js veya mevcut JavaScript içinde
    function sortCategoriesForDisplay(categories) {
        return [...categories].sort((a, b) => {
            // 'diger' her zaman en sonda
            if (a.toLowerCase() === 'diger') return 1;
            if (b.toLowerCase() === 'diger') return -1;
            
            // Diğer kategorileri alfabetik sırala
            return a.localeCompare(b, 'tr');
        });
    }

    // stats.js veya mevcut JavaScript içinde
    function sortCategoriesForStats(categoriesData) {
        return [...categoriesData].sort((a, b) => {
            // 'diger' her zaman en sonda
            if (a.category.toLowerCase() === 'diger') return 1;
            if (b.category.toLowerCase() === 'diger') return -1;
            
            // Veya soru sayısına göre sırala:
            return b.cnt - a.cnt; // Çoktan aza
            // return a.category.localeCompare(b.category, 'tr'); // Alfabetik
        });
    }

    // Kullanım
    async function refreshCategories() {
        try {
            const response = await fetch('/categories.json');
            if (!response.ok) throw new Error('Kategoriler yüklenemedi');
            
            const categories = await response.json();
            const sortedCategories = sortCategoriesForDisplay(categories);
            updateCategorySelect(sortedCategories);
            
        } catch (error) {
            console.error('Kategori yenileme hatası:', error);
        }
    }

    function updateCategorySelect(categories) {
        const currentValue = catSel.value;
        
        // Tüm option'ları temizle (ilk iki hariç)
        while (catSel.options.length > 2) {
            catSel.remove(2); // İlk iki option'ı koru
        }
        
        // Kategorileri alfabetik sırala ve ekle
        categories.sort().forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            catSel.add(option, catSel.options[catSel.options.length - 1]);
        });
        
        // Önceki değeri geri yükle (eğer hala mevcutsa)
        if (currentValue && Array.from(catSel.options).some(opt => opt.value === currentValue)) {
            catSel.value = currentValue;
        }
    }

    // === RECENT MODAL FUNCTIONS ===
    function openRecentModal() {
      recentModal.style.display = 'block';
      recentModal.setAttribute('aria-hidden', 'false');
    }

    function closeRecentModal() {
      recentModal.style.display = 'none';
      recentModal.setAttribute('aria-hidden', 'true');
    }

    async function loadRecentRecords() {
      const countSpan = document.getElementById('recentCount');
      const loading = document.getElementById('recentLoading');
      const table = document.getElementById('recentTable');
      const tbody = document.getElementById('recentTbody');
      const errorDiv = document.getElementById('recentError');

      // Reset UI state
      loading.style.display = 'block';
      table.style.display = 'none';
      errorDiv.style.display = 'none';
      tbody.innerHTML = '';

      try {
        // Determine URL based on search query
        const url = recentQuery
          ? `/questions/search?query=${encodeURIComponent(recentQuery)}&limit=100`
          : `/questions?limit=100&offset=0`;

        // Fetch data and total count
        const [dataResponse, totalResponse] = await Promise.all([
          fetch(url),
          fetch('/stats/total')
        ]);

        if (!dataResponse.ok) throw new Error('HTTP ' + dataResponse.status);

        const rows = await dataResponse.json();
        const total = totalResponse.ok ? (await totalResponse.json()).total : null;

        // Update count display
        if (countSpan) {
          countSpan.textContent = total !== null ? `(${total})` : '';
        }

        // Populate table
        if (!Array.isArray(rows) || rows.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="padding:8px;color:#aaa;">Kayıt bulunamadı.</td></tr>';
        } else {
          for (const record of rows) {
            tbody.insertAdjacentHTML('beforeend',
              `<tr data-row-id="${record.id ?? ''}">
                 <td style="border-bottom:1px solid #222;padding:8px;">${record.id ?? ''}</td>
                 <td style="border-bottom:1px solid #222;padding:8px;">${safeHtml(record.question)}</td>
                 <td style="border-bottom:1px solid #222;padding:8px;">${safeHtml(record.category)}</td>
                 <td style="border-bottom:1px solid #222;padding:8px;">${formatDateTime(record.created_at)}</td>
                 <td style="border-bottom:1px solid #222;padding:8px;">${safeHtml(record.created_by || 'anonymous')}</td>
                 <td style="border-bottom:1px solid #222;padding:8px;">
                    <button class="btn-del" data-id="${record.id ?? ''}" style="background:#933;color:#fff;border:0;padding:6px 10px;cursor:pointer;">Sil</button>
                  </td>
               </tr>`);
          }
        }

        table.style.display = 'table';
      } catch (error) {
        errorDiv.textContent = 'Hata: ' + error.message;
        errorDiv.style.display = 'block';
      } finally {
        loading.style.display = 'none';
      }
    }

    // Tarih formatlama fonksiyonu
    function formatDateTime(dateTimeStr) {
        if (!dateTimeStr) return '';
        
        try {
            const date = new Date(dateTimeStr);
            return date.toLocaleString('tr-TR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).replace(',', '');
        } catch (e) {
            return dateTimeStr; // Hata durumunda orijinal değeri döndür
        }
    }

    // === STATS MODAL FUNCTIONS ===
    function openStatsModal() {
      statsModal.style.display = 'block';
      statsModal.setAttribute('aria-hidden', 'false');
    }

    function closeStatsModal() {
      statsModal.style.display = 'none';
      statsModal.setAttribute('aria-hidden', 'true');
    }

    let chart = null; // Global chart instance

    async function loadStatsData() {
        try {
            const [categoriesResponse, totalResponse] = await Promise.all([
                fetch('/stats/categories'),
                fetch('/stats/total')
            ]);
            
            if (!categoriesResponse.ok) throw new Error('Kategoriler yüklenemedi');
            
            const rows = await categoriesResponse.json();
            const total = totalResponse.ok ? (await totalResponse.json()).total : 0;
            
            // Veriyi normalize et
            const data = rows.map(x => ({
                category: x.category ?? x['category'],
                cnt: Number(x.cnt ?? x['cnt'] ?? 0)
            }));
            
            // ÖZEL SIRALAMA: diger en sonda, diğerleri alfabetik
            const sortedData = sortCategoriesSpecial(data);

            // Özet istatistikleri güncelle
            document.getElementById('totalQuestions').textContent = total;
            document.getElementById('totalCategories').textContent = sortedData.length;
            document.getElementById('avgPerCategory').textContent = 
                sortedData.length > 0 ? (total / sortedData.length).toFixed(1) : '0';

            // Chart.js ile pasta grafik oluştur
            drawPieChart(sortedData);
            
        } catch (error) {
            console.error('İstatistik hatası:', error);
            alert('İstatistikler yüklenirken hata oluştu: ' + error.message);
        }
    }

    function drawPieChart(data) {
        const ctx = document.getElementById('catChart').getContext('2d');
        
        // Eski chart'ı temizle - GÜVENLİ VERSİYON
        if (typeof chart !== 'undefined' && chart !== null) {
            chart.destroy();
            chart = null;
        }

        // Boş veri kontrolü
        if (data.length === 0 || data.every(item => item.cnt === 0)) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.fillStyle = '#aaa';
            ctx.font = '16px system-ui';
            ctx.textAlign = 'center';
            ctx.fillText('Henüz veri bulunmamaktadır', ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }
        
        const labels = data.map(d => d.category);
        const counts = data.map(d => d.cnt);
        
        // Özel renk paleti - diger kategorisi gri olsun
        const backgroundColors = generateSpecialColors(data);
        
        chart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: counts,
                    backgroundColor: backgroundColors,
                    borderColor: '#111',
                    borderWidth: 2,
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'left',
                        labels: {
                            generateLabels(chart) {
                              // 1) Default label’ları al
                              const defaults = Chart.overrides.pie.plugins.legend.labels.generateLabels(chart);
                              const ds = chart.data.datasets[0];
                              const total = ds.data.reduce((a, b) => a + b, 0);
                              // 2) Sadece metni zenginleştir
                              return defaults.map((item, i) => {
                                const value = ds.data[i];
                                const pct = total > 0 ? ((value / total) * 100).toFixed(1) : '0';
                                return {
                                  ...item,                         // ← default stiller (renk vb.) korunur
                                  text: `${chart.data.labels[i]}: ${value} (${pct}%)`,
                                };
                              });
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#4ea',
                        bodyColor: '#cccccc',
                        borderColor: '#333',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((context.raw / total) * 100).toFixed(1) : '0';
                                return `${context.label}: ${context.raw} soru (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    function generateSpecialColors(data) {
        const colors = [];
        const hueStep = 360 / (data.length - 1); // diger hariç
        
        data.forEach((item, index) => {
            if (item.category.toLowerCase() === 'diger') {
                // diger kategorisi için gri renk
                colors.push('hsla(0, 0%, 60%, 0.8)');
            } else {
                // Diğer kategoriler için canlı renkler
                const hue = (index * hueStep) % 360;
                colors.push(`hsla(${hue}, 70%, 60%, 0.8)`);
            }
        });
        
        return colors;
    }

    function sortCategoriesSpecial(categoriesData) {
        return categoriesData.sort((a, b) => {
            // 'diger' her zaman en sonda olsun
            if (a.category.toLowerCase() === 'diger') return 1;
            if (b.category.toLowerCase() === 'diger') return -1;
            
            // Diğer kategorileri alfabetik sırala
            return b.cnt - a.cnt;
        });
    }

    // Türkçe karakter desteği için localeCompare
    function turkishSort(a, b) {
        const turkishMap = { 'ç': 'c', 'ğ': 'g', 'ı': 'i', 'ö': 'o', 'ş': 's', 'ü': 'u' };
        const normalize = str => str.toLowerCase().replace(/[çğıöşü]/g, char => turkishMap[char]);
        return normalize(a).localeCompare(normalize(b), 'tr');
    }

    // Dışa aktarma fonksiyonu
    document.getElementById('exportStats').addEventListener('click', function() {
        if (chart) {
            const imageLink = document.createElement('a');
            imageLink.href = chart.toBase64Image();
            imageLink.download = 'kategori-istatistikleri.png';
            imageLink.click();
        }
    });


    // === EVENT LISTENERS ===

    // Recent modal events
    document.getElementById('btnRecent').onclick = async () => {
      openRecentModal();
      await loadRecentRecords();
    };

    document.getElementById('closeRecent').onclick = closeRecentModal;
    document.getElementById('closeRecent2').onclick = closeRecentModal;
    document.getElementById('refreshRecent').onclick = loadRecentRecords;

    // Recent modal backdrop click
    recentModal.addEventListener('click', (e) => {
      if (e.target === recentModal) closeRecentModal();
    });

    // Search functionality
    recentSearch.addEventListener('input', debounce(() => {
      recentQuery = recentSearch.value.trim();
      loadRecentRecords();
    }, 300));

    recentClear.onclick = () => {
      recentSearch.value = '';
      recentQuery = '';
      loadRecentRecords();
    };

    // Stats modal events
    document.getElementById('btnStats').onclick = async () => {
      openStatsModal();
      await loadStatsData();
    };

    document.getElementById('closeStats').onclick = closeStatsModal;
    document.getElementById('closeStats2').onclick = closeStatsModal;
    document.getElementById('refreshStats').onclick = loadStatsData;

    // Stats modal backdrop click
    statsModal.addEventListener('click', (e) => {
      if (e.target === statsModal) closeStatsModal();
    });

    // created_by alanı için localStorage desteği
    (function() {
      // Sayfa yüklendiğinde localStorage'dan kullanıcı adını yükle
      const savedUser = localStorage.getItem('faq_studio_user');
      if (savedUser) {
        createdByInput.value = savedUser;
      }

      // Kullanıcı adı değiştiğinde localStorage'a kaydet
      createdByInput.addEventListener('change', function() {
        if (this.value.trim()) {
          localStorage.setItem('faq_studio_user', this.value.trim());
        }
      });
    })();

    // Silme modalı için
    let currentDeleteId = null;
    let currentDeleteQuestion = null;

    function showDeleteModal(id, question) {
      currentDeleteId = id;
      currentDeleteQuestion = question;
      
      document.getElementById('deleteId').textContent = id;
      document.getElementById('deleteQuestion').textContent = question;
      
      // Kullanıcı adını doldur (localStorage'dan)
      const savedUser = localStorage.getItem('faq_studio_user');
      document.getElementById('deleterName').value = savedUser || 'anonymous';
      
      document.getElementById('deleteModal').style.display = 'block';
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').style.display = 'none';
      currentDeleteId = null;
      currentDeleteQuestion = null;
    }

    async function confirmDelete() {
      const deletedBy = document.getElementById('deleterName').value || 'anonymous';
      
      try {
        const formData = new FormData();
        formData.append('deleted_by', deletedBy);
        
        const response = await fetch(`/questions/${currentDeleteId}`, {
          method: 'DELETE',
          body: formData
        });
        
        if (response.ok) {
          // Listeyi yenile
          await loadRecentRecords();
          closeDeleteModal();
        }
      } catch (error) {
        alert('Silme hatası: ' + error.message);
      }
    }

    // Sil butonlarını modal'a bağla (soru bilgisini de al)
    document.getElementById('recentTbody').addEventListener('click', async (e) => {
      const btn = e.target.closest('.btn-del');
      if (!btn) return;
      
      const tr = btn.closest('tr');
      if (!tr) return;
      
      const id = btn.getAttribute('data-id');
      const question = tr.querySelector('td:nth-child(2)').textContent; // Soru sütunundan al
      
      if (id && question) {
        showDeleteModal(id, question);
      }
    });

    // Sayfa yüklendiğinde kategorileri yükle
    document.addEventListener('DOMContentLoaded', async () => {
      await refreshCategories();
    });
  </script>
</body>
</html>